
name: Pytest

on:
  # Runs on pushes targeting the master, develop branch
  push:
    branches: [ master, develop ]
  # Runs on pull-request targeting the master, develop branch
  pull_request:
    branches: [ master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - omc-version: omc1.14
            python-version: py3.8
            os: buster
          - omc-version: omc1.14
            python-version: py3.10
            os: buster
          - omc-version: omc1.16
            python-version: py3.8
            os: buster
          - omc-version: omc1.16
            python-version: py3.10
            os: buster
          - omc-version: omc1.17
            python-version: py3.8
            os: buster
          - omc-version: omc1.17
            python-version: py3.10
            os: buster
          - omc-version: omc1.18
            python-version: py3.8
            os: bullseye
          - omc-version: omc1.18
            python-version: py3.10
            os: bullseye
          - omc-version: omc1.19
            python-version: py3.8
            os: bullseye
          - omc-version: omc1.19
            python-version: py3.10
            os: bullseye
          - omc-version: omc1.20
            python-version: py3.8
            os: bullseye
          - omc-version: omc1.20
            python-version: py3.10
            os: bullseye
          - omc-version: omc1.21
            python-version: py3.8
            os: bullseye
          - omc-version: omc1.21
            python-version: py3.10
            os: bullseye
          - omc-version: omc1.22
            python-version: py3.8
            os: bookworm
          - omc-version: omc1.22
            python-version: py3.10
            os: bookworm

    container:
      image: ijknabla/openmodelica-python3:${{ matrix.omc-version }}-${{ matrix.python-version }}-${{ matrix.os }}

    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        run: |
          curl -sSL https://install.python-poetry.org | sudo -u user python - --version=1.5.1
          alias poetry='sudo -u user /home/user/.local/bin/poetry'
          poetry install --only=main,test
      - name: Check version
        run: |
          alias poetry='sudo -u user /home/user/.local/bin/poetry'
          poetry run omc --version
          poetry run python --version
          poetry run pytest --version
      - name: Test python code
        run: |
          alias poetry='sudo -u user /home/user/.local/bin/poetry'
          poetry run pytest -v
