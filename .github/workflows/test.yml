
name: Pytest

on:
  # Runs on pushes targeting the master, develop branch
  push:
    branches: [ master, develop ]
  # Runs on pull-request targeting the master, develop branch
  pull_request:
    branches: [ master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - omc-version: 1.13.2
            python-version: 3.8
          - omc-version: 1.13.2
            python-version: 3.11
          - omc-version: 1.14.2
            python-version: 3.8
          # - omc-version: omc1.14
          #   python-version: py3.10
          #   os: buster
          # - omc-version: omc1.16
          #   python-version: py3.8
          #   os: buster
          # - omc-version: omc1.16
          #   python-version: py3.10
          #   os: buster
          # - omc-version: omc1.17
          #   python-version: py3.8
          #   os: buster
          # - omc-version: omc1.17
          #   python-version: py3.10
          #   os: buster
          # - omc-version: omc1.18
          #   python-version: py3.8
          #   os: bullseye
          # - omc-version: omc1.18
          #   python-version: py3.10
          #   os: bullseye
          # - omc-version: omc1.19
          #   python-version: py3.8
          #   os: bullseye
          # - omc-version: omc1.19
          #   python-version: py3.10
          #   os: bullseye
          # - omc-version: omc1.20
          #   python-version: py3.8
          #   os: bullseye
          # - omc-version: omc1.20
          #   python-version: py3.10
          #   os: bullseye
          # - omc-version: omc1.21
          #   python-version: py3.8
          #   os: bullseye
          # - omc-version: omc1.21
          #   python-version: py3.10
          #   os: bullseye
          # - omc-version: omc1.22
          #   python-version: py3.8
          #   os: bookworm
          # - omc-version: omc1.22
          #   python-version: py3.10
          #   os: bookworm

    container:
      image: ijknabla/openmodelica:v${{ matrix.omc-version }}-python${{ matrix.python-version }}

    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        run: |
          python${{ matrix.python-version }} -m pip install -U pip
          python${{ matrix.python-version }} -m pip install ./ pytest pytest-asyncio pytest-cov typing-extensions
      - name: Check version
        run: |
          omc --version
          python${{ matrix.python-version }} --version
          python${{ matrix.python-version }} -m pytest --version
      - name: Test python code
        run: |
          sudo -u user python${{ matrix.python-version }} -m pytest -v
